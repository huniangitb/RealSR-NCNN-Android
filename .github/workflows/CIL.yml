name: Compile RealSR-NCNN-Android-CLI

on:
  repository_dispatch:
  workflow_dispatch:
env:
  CI_NAME: Custom CI
  ASSETS_URL: https://github.com/tumuyan/RealSR-NCNN-Android/releases/download/1.9.6/assets.zip
  NCNN_URL: https://github.com/Tencent/ncnn/releases/download/20241226/ncnn-20241226-android-vulkan-shared.zip
  NCNN_NAME: ncnn-20241226-android-vulkan-shared.zip

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout last commit
      uses: actions/checkout@v4.2.2
      with:
        fetch-depth: 0

    - name: Download NCNN and Assets
      run: |
        wget $ASSETS_URL
        wget $NCNN_URL
        mkdir -p 3rdparty
        unzip -o assets.zip -d RealSR-NCNN-Android-GUI/app/src/main/assets
        unzip -o $NCNN_NAME -d 3rdparty/ncnn-android-vulkan-shared

    - name: Install dependencies for OpenCV
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git pkg-config \
            libavcodec-dev libavformat-dev libswscale-dev \
            libtbb-dev libjpeg-dev libpng-dev libtiff-dev \
            libgtk-3-dev libdc1394-dev libvulkan-dev

    - name: Clone and build OpenCV from source
      run: |
        git clone https://github.com/opencv/opencv.git -b 4.9.0
        git clone https://github.com/opencv/opencv_contrib.git -b 4.9.0
        mkdir opencv/build && cd opencv/build
        cmake -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX=/usr/local \
              -DOPENCV_EXTRA_MODULES_PATH=../../opencv_contrib/modules \
              -DWITH_VULKAN=ON \
              -DBUILD_LIST=core,imgproc,features2d
        make -j$(($(nproc) - 1))
        sudo make install

    - name: Verify OpenCV installation
      run: |
        if [ ! -d "/usr/local/lib/cmake/opencv4" ]; then
          echo "::error::OpenCV installation failed!"
          exit 1
        fi
        echo "OpenCV_DIR=/usr/local/lib/cmake/opencv4" >> $GITHUB_ENV
        echo "CMAKE_PREFIX_PATH=/usr/local:$CMAKE_PREFIX_PATH" >> $GITHUB_ENV

    - name: Setup Java
      uses: actions/setup-java@v4.6.0
      with:
        distribution: "temurin"
        java-version: 21
        cache: 'gradle'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3.2.2

    - name: Build CLI
      run: |
        cd RealSR-NCNN-Android-CLI
        sed -i "s|set(OpenCV_DIR.*|set(OpenCV_DIR /usr/local/lib/cmake/opencv4)|" app/src/main/cpp/CMakeLists.txt
        chmod +x gradlew
        ./gradlew assembleDebug -PopenCV_DIR=/usr/local/lib/cmake/opencv4

    - name: Upload CLI artifact
      uses: actions/upload-artifact@v4.6.0
      with:
        name: RealSR-NCNN-Android-CLI.zip
        path: RealSR-NCNN-Android-CLI/**/build/intermediates/cmake/release/obj/arm64-v8a
        retention-days: 90
